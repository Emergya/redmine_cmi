<%
# Fix error when update plugin from previous version
Setting.plugin_redmine_cmi['providers_tracker'] = [Setting.plugin_redmine_cmi['providers_tracker']] if !Setting.plugin_redmine_cmi['providers_tracker'].is_a?(Array)
%>

<div class="splitcontentleft">
  <fieldset>
    <legend><%=l :label_tracker_plural %></legend>
    <p>
      <label><%=l :'cmi.label_incidents' %></label>
      <%= select_tag 'settings[incidents_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['incidents_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_risks' %></label>
      <%= select_tag 'settings[risks_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['risks_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_change_request' %></label>
      <%= select_tag 'settings[changes_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['changes_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_nonconformities' %></label>
      <%= select_tag 'settings[qa_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['qa_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_bpo' %></label>
      <%= select_tag 'settings[bpo_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['bpo_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_bills' %></label>
      <%= select_tag 'settings[bill_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['bill_tracker'].to_i)).html_safe %>
    </p>
    <p>
      <label><%=l :'cmi.label_providers' %></label>
      <%= select_tag 'settings[providers_tracker]',
          ('<option></option>' +
            options_from_collection_for_select(Tracker.all, :id, :name, @settings['providers_tracker'])).html_safe, :multiple => true %>
    </p>
    
  </fieldset>
  <fieldset>
    <legend><%=l :label_custom_field_plural %></legend>
    <p>
      <label><%=l :'cmi.label_bpo_amount_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['bpo_tracker'].present? 
          options = ('<option></option>'+options_from_collection_for_select(Tracker.find(Setting.plugin_redmine_cmi['bpo_tracker']).custom_fields, :id, :name, @settings['bpo_tracker_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[bpo_tracker_custom_field]', options %>
      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_bpo_tracker').change(function(){
        $('#settings_bpo_tracker_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_bpo_tracker').val()});
        });
      </script>
    </p>

    <p>
      <label><%=l :'cmi.label_bill_amount_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['bill_tracker'].present? 
          options = ('<option></option>'+options_from_collection_for_select(Tracker.find(Setting.plugin_redmine_cmi['bill_tracker']).custom_fields, :id, :name, @settings['bill_amount_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[bill_amount_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_bill_tracker').change(function(){
        $('#settings_bill_amount_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_bill_tracker').val()});
        });
      </script>
    </p>

    <p>
      <label><%=l :'cmi.label_bill_vesting_date_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['bill_tracker'].present? 
          options = ('<option></option>'+options_from_collection_for_select(Tracker.find(Setting.plugin_redmine_cmi['bill_tracker']).custom_fields, :id, :name, @settings['bill_tracker_vesting_date_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[bill_tracker_vesting_date_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_bill_tracker').change(function(){
        $('#settings_bill_tracker_vesting_date_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_bill_tracker').val()});
        });
      </script>
    </p> 

    <p>
      <label><%=l :'cmi.label_bill_paid_date_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['bill_tracker'].present? 
          options = ('<option></option>'+options_from_collection_for_select(Tracker.find(Setting.plugin_redmine_cmi['bill_tracker']).custom_fields, :id, :name, @settings['bill_tracker_paid_date_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[bill_tracker_paid_date_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_bill_tracker').change(function(){
        $('#settings_bill_tracker_paid_date_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_bill_tracker').val()});
        });
      </script>
    </p>

    <p>
      <label><%=l :'cmi.label_provider_amount_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['providers_tracker'].present? 
          shared_custom_fields = Tracker.find(Setting.plugin_redmine_cmi['providers_tracker']).map(&:custom_fields).reduce(:&)
          options = ('<option></option>'+options_from_collection_for_select(shared_custom_fields, :id, :name, @settings['providers_tracker_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[providers_tracker_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_providers_tracker').change(function(){
        $('#settings_providers_tracker_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_providers_tracker').val()});
        });
      </script>
    </p>

    <p>
      <label><%=l :'cmi.label_provider_vesting_date_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['providers_tracker'].present? 
          shared_custom_fields = Tracker.find(Setting.plugin_redmine_cmi['providers_tracker']).map(&:custom_fields).reduce(:&)
          options = ('<option></option>'+options_from_collection_for_select(shared_custom_fields, :id, :name, @settings['providers_tracker_vesting_date_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[providers_tracker_vesting_date_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_providers_tracker').change(function(){
        $('#settings_providers_tracker_vesting_date_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_providers_tracker').val()});
        });
      </script>
    </p>

    <p>
      <label><%=l :'cmi.label_provider_paid_date_custom_field' %></label>
      <%
        if Setting.plugin_redmine_cmi['providers_tracker'].present? 
          shared_custom_fields = Tracker.find(Setting.plugin_redmine_cmi['providers_tracker']).map(&:custom_fields).reduce(:&)
          options = ('<option></option>'+options_from_collection_for_select(shared_custom_fields, :id, :name, @settings['providers_tracker_paid_date_custom_field'].to_i)).html_safe
        else
          options = ('<option></option>').html_safe
        end
      %>
      <%= select_tag 'settings[providers_tracker_paid_date_custom_field]', options %>

      <!-- observe_field replacement for Redmine 2.3-->
      <script>
        $('#settings_providers_tracker').change(function(){
        $('#settings_providers_tracker_paid_date_custom_field').load('/settings/show_tracker_custom_fields', {tracker: $('#settings_providers_tracker').val()});
        });
      </script>
    </p>
  </fieldset>

  <fieldset>
    <legend><%=l :label_preferences %></legend>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_effort") %></label>
      <%= check_box_tag "settings[cmi_metrics_effort]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_effort] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_time") %></label>
      <%= check_box_tag "settings[cmi_metrics_time]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_time] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_cost") %></label>
      <%= check_box_tag "settings[cmi_metrics_cost]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_cost] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_advance") %></label>
      <%= check_box_tag "settings[cmi_metrics_advance]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_advance] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_profitability") %></label>
      <%= check_box_tag "settings[cmi_metrics_profitability]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_profitability] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_profitability") %></label>
      <%= check_box_tag "settings[cmi_metrics_profitability]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_profitability] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_profit") %></label>
      <%= check_box_tag "settings[cmi_metrics_income]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_income] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_cashflow") %></label>
      <%= check_box_tag "settings[cmi_metrics_cashflow]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_cashflow] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_deviation") %></label>
      <%= check_box_tag "settings[cmi_metrics_deviation]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_deviation] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_metrics")+" - "+l(:"cmi.label_others") %></label>
      <%= check_box_tag "settings[cmi_metrics_others]", 1, Setting.plugin_redmine_cmi[:cmi_metrics_others] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_yearly")+" - "+l(:"cmi.label_effort") %></label>
      <%= check_box_tag "settings[cmi_yearly_effort]", 1, Setting.plugin_redmine_cmi[:cmi_yearly_effort] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_yearly")+" - "+l(:"cmi.label_cost") %></label>
      <%= check_box_tag "settings[cmi_yearly_cost]", 1, Setting.plugin_redmine_cmi[:cmi_yearly_cost] == "1" %>
    </p>
    <p>
      <label><%= l(:"cmi.label_yearly")+" - "+l(:"cmi.label_pal") %></label>
      <%= check_box_tag "settings[cmi_yearly_pal]", 1, Setting.plugin_redmine_cmi[:cmi_yearly_pal] == "1" %>
    </p>
  </fieldset>
</div>
<div class="splitcontentright">
  <p>
    <label><%=l :'cmi.label_low_priorities' %></label>
    <%= select_tag 'settings[priority_low]',
        options_from_collection_for_select(IssuePriority.all, :id, :name, (@settings['priority_low'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_medium_priorities' %></label>
    <%= select_tag 'settings[priority_medium]',
        options_from_collection_for_select(IssuePriority.all, :id, :name, (@settings['priority_medium'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_high_priorities' %></label>
    <%= select_tag 'settings[priority_high]',
        options_from_collection_for_select(IssuePriority.all, :id, :name, (@settings['priority_high'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_accepted_statuses' %></label>
    <%= select_tag 'settings[status_accepted]',
        options_from_collection_for_select(IssueStatus.all, :id, :name, (@settings['status_accepted'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_rejected_statuses' %></label>
    <%= select_tag 'settings[status_rejected]',
        options_from_collection_for_select(IssueStatus.all, :id, :name, (@settings['status_rejected'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_pending_qa_statuses' %></label>
    <%= select_tag 'settings[status_pending]',
        options_from_collection_for_select(IssueStatus.all, :id, :name, (@settings['status_pending'] || []).collect(&:to_i)),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_bill_paid_statuses' %></label>
    <%= select_tag 'settings[bill_paid_statuses]',
        options_from_collection_for_select(IssueStatus.all, :id, :name, (@settings['bill_paid_statuses'] || [])),
        :multiple => true %>
  </p>
  <p>
    <label><%=l :'cmi.label_providers_paid_statuses' %></label>
    <%= select_tag 'settings[providers_paid_statuses]',
        options_from_collection_for_select(IssueStatus.all, :id, :name, (@settings['providers_paid_statuses'] || [])),
        :multiple => true %>
  </p>

  <p>
    <label><%=l :'cmi.caption_groups' %></label>
    <%= text_area_tag 'settings[groups]', @settings['groups'], :rows => 15 %><br />
    <em><%= l(:text_custom_field_possible_values_info) %></em>
  </p>
  <p>
    <label><%=l :'cmi.label_coordinator_role' %></label>
    <%= select_tag 'settings[coordinator_role]',
        ('<option></option>' +
          options_from_collection_for_select(User.roles, :to_s, :to_s, @settings['coordinator_role'])).html_safe %>
  </p>
</div>
<div style="clear: both;"></div>
